// *********************************************************************************************************************
// Includes
// *********************************************************************************************************************

#include <catch2/catch_test_macros.hpp>  // TEST_CASE

#include <freddy/dd/kfdd.hpp>    // kfdd_manager
#include <freddy/expansion.hpp>  // expansion::S

#include <cassert>  // assert
#include <cstdint>  // std::uint32_t
#include <vector>   // std::vector

// *********************************************************************************************************************
// Namespaces
// *********************************************************************************************************************

using namespace freddy;

namespace
{

// =====================================================================================================================
// Functions
// =====================================================================================================================

template <typename DD1, typename DD2>
auto eval_dds(DD1 const& dd1, DD2 const& dd2)
{
    assert(dd1.manager().var_count() == dd2.manager().var_count());

    auto const no_vars = static_cast<std::uint32_t>(dd1.manager().var_count());
    assert(no_vars <= 64);

    std::uint64_t const no_combs = 1ULL << no_vars;

    // Pre-allocate input vector once to avoid repeated allocations in the loop
    std::vector<bool> input_vars(no_vars);

    for (std::uint64_t i = 0; i < no_combs; ++i)
    {
        for (std::uint32_t j = 0; j < no_vars; j++)
        {
            input_vars[j] = (i & (1ULL << j)) != 0u;
        }
        if (dd1.eval(input_vars) != dd2.eval(input_vars))
        {
            return false;
        }
    }
    return true;
}

}  // namespace

// *********************************************************************************************************************
// Macros
// *********************************************************************************************************************

TEST_CASE("kfdd ringsum sift test", "[example]")
{
    kfdd_manager mgr_ctrl{};
    std::vector<kfdd> c(15);
    for (auto i = 0; i < 15; ++i)
    {
        c[i] = mgr_ctrl.var(expansion::S);
    }

    kfdd_manager mgr{};
    std::vector<kfdd> v(15);
    for (auto i = 0; i < 15; ++i)
    {
        v[i] = mgr.var(expansion::S);
    }

    auto const result_c = (c[4] & c[10] & c[13] & c[12] & c[6] & c[11] & c[8] & c[1] & c[3] & c[2]) ^
                          (c[10] & c[6] & c[13] & c[8] & c[11] & c[14] & c[2] & c[12] & c[3] & c[4]) ^
                          (c[5] & c[8] & c[4] & c[9] & c[14] & c[13] & c[2] & c[11] & c[10] & c[6]) ^
                          (c[13] & c[8] & c[5] & c[0] & c[11] & c[2] & c[1] & c[10] & c[12] & c[14]) ^
                          (c[3] & c[1] & c[10] & c[0] & c[6] & c[11] & c[7] & c[9] & c[4] & c[12]) ^
                          (c[7] & c[12] & c[8] & c[0] & c[10] & c[6] & c[9] & c[5] & c[4] & c[14]) ^
                          (c[5] & c[11] & c[10] & c[3] & c[6] & c[8] & c[4] & c[13] & c[2] & c[7]) ^
                          (c[11] & c[8] & c[10] & c[0] & c[9] & c[12] & c[2] & c[1] & c[5] & c[13]) ^
                          (c[8] & c[0] & c[4] & c[14] & c[3] & c[13] & c[11] & c[9] & c[7] & c[5]) ^
                          (c[4] & c[2] & c[10] & c[8] & c[3] & c[14] & c[5] & c[1] & c[0] & c[7]) ^
                          (c[4] & c[0] & c[8] & c[12] & c[6] & c[5] & c[1] & c[14] & c[9] & c[2]) ^
                          (c[4] & c[11] & c[8] & c[3] & c[14] & c[0] & c[12] & c[5] & c[6] & c[10]) ^
                          (c[9] & c[11] & c[2] & c[8] & c[13] & c[1] & c[14] & c[5] & c[10] & c[4]) ^
                          (c[8] & c[2] & c[6] & c[14] & c[11] & c[9] & c[1] & c[4] & c[12] & c[10]) ^
                          (c[3] & c[9] & c[13] & c[4] & c[14] & c[12] & c[1] & c[2] & c[10] & c[0]) ^
                          (c[4] & c[0] & c[11] & c[12] & c[10] & c[13] & c[9] & c[1] & c[5] & c[6]) ^
                          (c[1] & c[0] & c[13] & c[5] & c[14] & c[9] & c[10] & c[6] & c[8] & c[3]) ^
                          (c[0] & c[7] & c[4] & c[11] & c[3] & c[6] & c[1] & c[14] & c[2] & c[5]) ^
                          (c[11] & c[12] & c[8] & c[2] & c[6] & c[9] & c[7] & c[13] & c[0] & c[1]) ^
                          (c[6] & c[2] & c[7] & c[14] & c[0] & c[5] & c[9] & c[12] & c[1] & c[3]) ^
                          (c[12] & c[1] & c[0] & c[11] & c[10] & c[7] & c[2] & c[14] & c[4] & c[6]) ^
                          (c[7] & c[14] & c[3] & c[6] & c[0] & c[1] & c[10] & c[4] & c[9] & c[8]) ^
                          (c[1] & c[4] & c[9] & c[5] & c[3] & c[8] & c[12] & c[7] & c[11] & c[14]) ^
                          (c[10] & c[7] & c[13] & c[5] & c[0] & c[1] & c[4] & c[2] & c[9] & c[11]) ^
                          (c[11] & c[8] & c[14] & c[2] & c[12] & c[6] & c[3] & c[7] & c[9] & c[5]) ^
                          (c[9] & c[3] & c[10] & c[13] & c[14] & c[12] & c[0] & c[1] & c[4] & c[5]) ^
                          (c[2] & c[5] & c[1] & c[9] & c[11] & c[7] & c[10] & c[0] & c[3] & c[14]) ^
                          (c[10] & c[3] & c[12] & c[13] & c[1] & c[7] & c[9] & c[2] & c[11] & c[0]) ^
                          (c[9] & c[2] & c[10] & c[12] & c[4] & c[0] & c[6] & c[8] & c[7] & c[13]) ^
                          (c[10] & c[14] & c[6] & c[7] & c[13] & c[9] & c[4] & c[5] & c[12] & c[3]) ^
                          (c[3] & c[11] & c[5] & c[13] & c[6] & c[12] & c[10] & c[7] & c[14] & c[2]) ^
                          (c[1] & c[10] & c[5] & c[9] & c[7] & c[2] & c[12] & c[4] & c[6] & c[8]) ^
                          (c[10] & c[2] & c[11] & c[7] & c[3] & c[6] & c[1] & c[13] & c[4] & c[8]) ^
                          (c[2] & c[6] & c[7] & c[3] & c[9] & c[13] & c[5] & c[0] & c[11] & c[4]) ^
                          (c[4] & c[12] & c[14] & c[9] & c[0] & c[13] & c[3] & c[5] & c[7] & c[10]) ^
                          (c[3] & c[4] & c[12] & c[7] & c[9] & c[6] & c[13] & c[8] & c[11] & c[1]) ^
                          (c[8] & c[5] & c[2] & c[12] & c[3] & c[10] & c[9] & c[13] & c[1] & c[11]) ^
                          (c[1] & c[5] & c[9] & c[3] & c[12] & c[0] & c[13] & c[11] & c[2] & c[10]) ^
                          (c[9] & c[13] & c[14] & c[10] & c[4] & c[6] & c[8] & c[7] & c[3] & c[2]) ^
                          (c[9] & c[8] & c[14] & c[1] & c[6] & c[7] & c[3] & c[13] & c[12] & c[11]) ^
                          (c[1] & c[8] & c[5] & c[4] & c[0] & c[3] & c[7] & c[13] & c[11] & c[12]) ^
                          (c[12] & c[1] & c[5] & c[3] & c[10] & c[8] & c[4] & c[2] & c[9] & c[6]) ^
                          (c[3] & c[11] & c[5] & c[14] & c[13] & c[10] & c[9] & c[6] & c[7] & c[2]) ^
                          (c[13] & c[8] & c[11] & c[12] & c[14] & c[7] & c[10] & c[6] & c[9] & c[4]) ^
                          (c[14] & c[13] & c[12] & c[0] & c[2] & c[7] & c[1] & c[11] & c[8] & c[3]) ^
                          (c[12] & c[5] & c[14] & c[2] & c[3] & c[10] & c[8] & c[1] & c[13] & c[0]) ^
                          (c[13] & c[7] & c[8] & c[14] & c[12] & c[9] & c[6] & c[1] & c[11] & c[3]) ^
                          (c[2] & c[13] & c[3] & c[4] & c[14] & c[7] & c[6] & c[9] & c[0] & c[8]) ^
                          (c[7] & c[8] & c[3] & c[14] & c[13] & c[6] & c[9] & c[1] & c[10] & c[0]) ^
                          (c[3] & c[1] & c[8] & c[12] & c[9] & c[10] & c[14] & c[2] & c[6] & c[4]);

    auto const result_v = (v[4] & v[10] & v[13] & v[12] & v[6] & v[11] & v[8] & v[1] & v[3] & v[2]) ^
                          (v[10] & v[6] & v[13] & v[8] & v[11] & v[14] & v[2] & v[12] & v[3] & v[4]) ^
                          (v[5] & v[8] & v[4] & v[9] & v[14] & v[13] & v[2] & v[11] & v[10] & v[6]) ^
                          (v[13] & v[8] & v[5] & v[0] & v[11] & v[2] & v[1] & v[10] & v[12] & v[14]) ^
                          (v[3] & v[1] & v[10] & v[0] & v[6] & v[11] & v[7] & v[9] & v[4] & v[12]) ^
                          (v[7] & v[12] & v[8] & v[0] & v[10] & v[6] & v[9] & v[5] & v[4] & v[14]) ^
                          (v[5] & v[11] & v[10] & v[3] & v[6] & v[8] & v[4] & v[13] & v[2] & v[7]) ^
                          (v[11] & v[8] & v[10] & v[0] & v[9] & v[12] & v[2] & v[1] & v[5] & v[13]) ^
                          (v[8] & v[0] & v[4] & v[14] & v[3] & v[13] & v[11] & v[9] & v[7] & v[5]) ^
                          (v[4] & v[2] & v[10] & v[8] & v[3] & v[14] & v[5] & v[1] & v[0] & v[7]) ^
                          (v[4] & v[0] & v[8] & v[12] & v[6] & v[5] & v[1] & v[14] & v[9] & v[2]) ^
                          (v[4] & v[11] & v[8] & v[3] & v[14] & v[0] & v[12] & v[5] & v[6] & v[10]) ^
                          (v[9] & v[11] & v[2] & v[8] & v[13] & v[1] & v[14] & v[5] & v[10] & v[4]) ^
                          (v[8] & v[2] & v[6] & v[14] & v[11] & v[9] & v[1] & v[4] & v[12] & v[10]) ^
                          (v[3] & v[9] & v[13] & v[4] & v[14] & v[12] & v[1] & v[2] & v[10] & v[0]) ^
                          (v[4] & v[0] & v[11] & v[12] & v[10] & v[13] & v[9] & v[1] & v[5] & v[6]) ^
                          (v[1] & v[0] & v[13] & v[5] & v[14] & v[9] & v[10] & v[6] & v[8] & v[3]) ^
                          (v[0] & v[7] & v[4] & v[11] & v[3] & v[6] & v[1] & v[14] & v[2] & v[5]) ^
                          (v[11] & v[12] & v[8] & v[2] & v[6] & v[9] & v[7] & v[13] & v[0] & v[1]) ^
                          (v[6] & v[2] & v[7] & v[14] & v[0] & v[5] & v[9] & v[12] & v[1] & v[3]) ^
                          (v[12] & v[1] & v[0] & v[11] & v[10] & v[7] & v[2] & v[14] & v[4] & v[6]) ^
                          (v[7] & v[14] & v[3] & v[6] & v[0] & v[1] & v[10] & v[4] & v[9] & v[8]) ^
                          (v[1] & v[4] & v[9] & v[5] & v[3] & v[8] & v[12] & v[7] & v[11] & v[14]) ^
                          (v[10] & v[7] & v[13] & v[5] & v[0] & v[1] & v[4] & v[2] & v[9] & v[11]) ^
                          (v[11] & v[8] & v[14] & v[2] & v[12] & v[6] & v[3] & v[7] & v[9] & v[5]) ^
                          (v[9] & v[3] & v[10] & v[13] & v[14] & v[12] & v[0] & v[1] & v[4] & v[5]) ^
                          (v[2] & v[5] & v[1] & v[9] & v[11] & v[7] & v[10] & v[0] & v[3] & v[14]) ^
                          (v[10] & v[3] & v[12] & v[13] & v[1] & v[7] & v[9] & v[2] & v[11] & v[0]) ^
                          (v[9] & v[2] & v[10] & v[12] & v[4] & v[0] & v[6] & v[8] & v[7] & v[13]) ^
                          (v[10] & v[14] & v[6] & v[7] & v[13] & v[9] & v[4] & v[5] & v[12] & v[3]) ^
                          (v[3] & v[11] & v[5] & v[13] & v[6] & v[12] & v[10] & v[7] & v[14] & v[2]) ^
                          (v[1] & v[10] & v[5] & v[9] & v[7] & v[2] & v[12] & v[4] & v[6] & v[8]) ^
                          (v[10] & v[2] & v[11] & v[7] & v[3] & v[6] & v[1] & v[13] & v[4] & v[8]) ^
                          (v[2] & v[6] & v[7] & v[3] & v[9] & v[13] & v[5] & v[0] & v[11] & v[4]) ^
                          (v[4] & v[12] & v[14] & v[9] & v[0] & v[13] & v[3] & v[5] & v[7] & v[10]) ^
                          (v[3] & v[4] & v[12] & v[7] & v[9] & v[6] & v[13] & v[8] & v[11] & v[1]) ^
                          (v[8] & v[5] & v[2] & v[12] & v[3] & v[10] & v[9] & v[13] & v[1] & v[11]) ^
                          (v[1] & v[5] & v[9] & v[3] & v[12] & v[0] & v[13] & v[11] & v[2] & v[10]) ^
                          (v[9] & v[13] & v[14] & v[10] & v[4] & v[6] & v[8] & v[7] & v[3] & v[2]) ^
                          (v[9] & v[8] & v[14] & v[1] & v[6] & v[7] & v[3] & v[13] & v[12] & v[11]) ^
                          (v[1] & v[8] & v[5] & v[4] & v[0] & v[3] & v[7] & v[13] & v[11] & v[12]) ^
                          (v[12] & v[1] & v[5] & v[3] & v[10] & v[8] & v[4] & v[2] & v[9] & v[6]) ^
                          (v[3] & v[11] & v[5] & v[14] & v[13] & v[10] & v[9] & v[6] & v[7] & v[2]) ^
                          (v[13] & v[8] & v[11] & v[12] & v[14] & v[7] & v[10] & v[6] & v[9] & v[4]) ^
                          (v[14] & v[13] & v[12] & v[0] & v[2] & v[7] & v[1] & v[11] & v[8] & v[3]) ^
                          (v[12] & v[5] & v[14] & v[2] & v[3] & v[10] & v[8] & v[1] & v[13] & v[0]) ^
                          (v[13] & v[7] & v[8] & v[14] & v[12] & v[9] & v[6] & v[1] & v[11] & v[3]) ^
                          (v[2] & v[13] & v[3] & v[4] & v[14] & v[7] & v[6] & v[9] & v[0] & v[8]) ^
                          (v[7] & v[8] & v[3] & v[14] & v[13] & v[6] & v[9] & v[1] & v[10] & v[0]) ^
                          (v[3] & v[1] & v[8] & v[12] & v[9] & v[10] & v[14] & v[2] & v[6] & v[4]);

    mgr.dtl_sift();

    CHECK(eval_dds(result_v, result_c));
}

TEST_CASE("simple ringsum", "[example]")
{
    kfdd_manager mgr1{};
    auto const x0 = mgr1.var(expansion::S);
    auto const x1 = mgr1.var(expansion::S);
    auto const x2 = mgr1.var(expansion::S);
    auto const x3 = mgr1.var(expansion::S);
    auto const x4 = mgr1.var(expansion::S);
    auto const ringsum = mgr1.one() ^ (x3 & x0) ^ (x4 & x0) ^ (x0 & x1);

    kfdd_manager mgr2{};
    auto const y0 = mgr2.var(expansion::S);
    auto const y1 = mgr2.var(expansion::S);
    auto const y2 = mgr2.var(expansion::S);
    auto const y3 = mgr2.var(expansion::S);
    auto const y4 = mgr2.var(expansion::S);
    auto const ringsum2 = mgr2.one() ^ (y3 & y0) ^ (y4 & y0) ^ (y0 & y1);

    mgr2.dtl_sift();

    CHECK(eval_dds(ringsum, ringsum2));
}

TEST_CASE("wiki example ringsum", "[example]")
{
    kfdd_manager mgr{};
    auto const a1 = mgr.var(expansion::S);
    auto const b1 = mgr.var(expansion::S);
    auto const c1 = mgr.var(expansion::S);
    auto const ringsum1 = mgr.one() ^ b1 ^ (a1 & b1) ^ (a1 & c1) ^ (a1 & b1 & c1);

    kfdd_manager mgr2{};
    auto const a2 = mgr2.var(expansion::S);
    auto const b2 = mgr2.var(expansion::S);
    auto const c2 = mgr2.var(expansion::S);
    auto const ringsum2 = mgr2.one() ^ b2 ^ (a2 & b2) ^ (a2 & c2) ^ (a2 & b2 & c2);

    mgr2.dtl_sift();

    CHECK(eval_dds(ringsum1, ringsum2));
}
